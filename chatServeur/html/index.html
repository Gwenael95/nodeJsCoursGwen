<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Chat Socket.IO</title>
</head>
<body>

<div id="app">
    <div v-if="this.pseudo===''">
        <label for="pseudo">Mon Pseudo</label>
        <input @keypress.enter="setPseudo()" v-model="pseudoValue" size="100" id="pseudo" placeholder="Mon pseudo"/>
        <p v-if="this.pseudoError" >ce pseudo existe déjà</p>

    </div>
    <div>
        <p v-if="this.pseudo!==''">{{this.pseudo}}</p>
    </div>
    <div v-if="this.pseudo!==''">
        <div>
            <textarea v-model="str_messages" cols="100" rows="30"></textarea>
        </div>
        <div>
            <input @keypress.enter="sendMessage" v-model="client_message" size="100" />
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
<script src="http://localhost:5055/socket.io/socket.io.js"></script>

<script>
    const socket = io('http://localhost:5055')

    socket.on('new_message', (data) => {
        app.messages.push(data)
    })
    socket.on('new_error', (data) => {
        app.pseudoError = data.error;
    })
    const app = new Vue({
        el: '#app',
        data() { return {
            pseudo:"",
            pseudoValue:"",
            client_message: '',
            messages: [],
            pseudoError:false,
        }},
        computed: {
            str_messages() {
                let str = ''
                for (let msg of this.messages) {
                    str += `[${msg.date}] ${msg.pseudo}: ${msg.message}\n`
                }
                return str
            }
        },
        methods: {
            sendMessage() {
                socket.emit('send_message', { message: this.client_message, pseudo:this.pseudo })
                this.client_message = ''
            },
            setPseudo(){
                socket.emit('set_pseudo', {  pseudo: this.pseudoValue })
                if (!this.pseudoError){
                    this.pseudo = this.pseudoValue
                    this.pseudoError=false;
                }

            }
        }
    })
</script>
</body>
</html>